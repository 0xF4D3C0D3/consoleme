{% include "header.html" %}
{% import ujson as json %}
<div id="wrapper" class="container">
    <script src="/static/js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf8" src="/static/js/common.js"></script>
    <script src="/static/js/ace/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/js/sweetalert2.js"></script>
    <script>
      // You can modify the editor theme by manually writing a localstorage variable for aceEditorTheme
      let editor_theme = localStorage.getItem("aceEditorTheme");
      if (editor_theme == null) {
            editor_theme = "monokai";
        }
      // Also the keyboard handler! vim and emacs are available.
      let keyboard_handler = localStorage.getItem("aceKeyboardHandler");
      let permissionCompleter = {
        getCompletions: function(editor, session, pos, prefix, callback) {
            if (prefix.length === 0) { callback(null, []); return }
            let row = session.getDocument().getLine(pos["row"]).trim().replace(/\"/g, "");
            $.getJSON(
                "/api/v1/policyuniverse/autocomplete/?prefix=" + row,
                function(wordList) {
                    callback(null, wordList.map(function(ea) {
                      var value = ea.permission;
                      if (row.indexOf(":") > -1) {
                        value = value.split(":")[1];
                      }
                      return {name: ea.permission, value: value, meta: "Permission"}
                    }));
                })
          }
      };
      let langTools = ace.require("ace/ext/language_tools");
      langTools.addCompleter(permissionCompleter);
      let permission_value = {};
      let readOnly = false;
      {% if read_only %}
        readOnly = true;
      {% end %}
    </script>

    <div class="ui dimmer">
        <div class="ui medium text loader">Loading</div>
    </div>
    <div class="ui basic modal">
        <div id="error_div" class="ui hidden error message">
            <div class="header">
                Oops!
            </div>
            <p id="error_response"></p>
        </div>
        <div id="success_div" class="ui hidden positive message">
            <div class="header">
                Success!
            </div>
            <p id="success_response"></p>
        </div>
        <div class="scrolling content">
            <div id="modal_content"></div>
        </div>
    </div>
    <h1 class="ui header"><a href="javascript:window.location.href=window.location.pathname + '?refresh=true'"><i class="refresh icon"></i></a> Resource: {{ arn }}</h1>

    {% if read_only %}
    <div class="ui warning message">
        <i class="close icon"></i>
        <div class="header">
          Read only access
        </div>
        <p>You currently have read only access to this resource.</p>
    </div>
    {% end %}

    {% if s3_errors %}
        <h2 class="ui header">Recent S3 Errors (<a target="_blank" href="{{ s3_query_url }}">Click here to query for recent S3 errors</a>)</h2>
        <div class="header">
            This section shows the S3 errors discovered for this role. <strong style="color: red;">WARNING</strong>: S3 error information is only fetched once
            per day, and it is up to 48 hours out of date.
        </div>
        <table class="ui celled table red">
            <thead>
                <tr>
                    <th>Error Call</th>
                    <th>Count</th>
                    <th>Role Name</th>
                    <th>Bucket Prefix</th>
                    <th>Error Status</th>
                    <th>Error Code</th>
                </tr>
            </thead>
            <tbody>
            {% for entry in s3_errors %}
                <tr>
                    <td class="negative">{{ entry.get("operation") }}</td>
                    <td class="negative">{{ entry.get("count") }}</td>
                    <td class="negative">{{ entry.get("role_arn") }}</td>
                    <td class="negative">{{ entry.get("request_prefix") or "" }}</td>
                    <td class="negative">{{ entry.get("error_status") or "" }}</td>
                    <td class="negative">{{ entry.get("error_code") or "" }}</td>
                </tr>
            {% end %}
            </tbody>
        </table>
    {% end %}
    <div>
    <h2 class="ui header">Resource Policy</h2>
        {% set editor = 'bucket_policy' %}
        <style type="text/css" media="screen">
            #{{ editor }} {
                border: 1px solid lightgray;
                margin: auto;
                height: 200px;
                width: 100%;
            }
            .ui.button {
                background: #ffffff;
            }
            .ui.centered.grid {
                margin-bottom: 5px;
            }
        </style>
        <div class="ui styled fluid accordion">
        <div class="active title">
            <i class="dropdown icon"></i>
            Resource Policy
        </div>
        <div class="active content">
            <pre id="{{ editor }}">{{ json.dumps(resource_details.get("Policy"), indent=4, sort_keys=True, escape_forward_slashes=False) }}</pre>
            <div class="scrollmargin"></div>
        </div>
        <input type="hidden" id={{ editor }}/>
        <div class="ui centered aligned grid">
            <div class="ui center floated">
                <button class="ui primary button" type="save" {% if read_only or not can_save_delete %}style="display: none;"{% end %}
                        onClick="policyEditor.editPolicy('ResourcePolicy', 'Resource Policy', {{ editor }});"
                        style="margin: 10px;">Save Resource Policy
                </button>
            </div>
        </div>
        <script>
          let {{ editor }} =
          ace.edit("{{ editor }}", {
            theme: "ace/theme/" + editor_theme,
            mode: "ace/mode/json",
            maxLines: 5000,
            wrap: true,
            autoScrollEditorIntoView: true,
            readOnly: readOnly,
            printMargin: false
          });
          if (keyboard_handler != null) {
            {{ editor }}.setKeyboardHandler("ace/keyboard/" + keyboard_handler)
          };
          {{ editor }}.resize()
          {{ editor }}.setOptions({enableBasicAutocompletion: true});
          {{ editor }}.setOptions({enableLiveAutocompletion: true});
          $('.ui.accordion')
            .accordion();
          let text_{{ editor }} = $('hidden[id="{{ editor }}"]');
          {{ editor }}.getSession().on("change", function () {
            text_{{ editor }}.val({{ editor }}.getSession().getValue()
          )
          });
        </script>
    </div>
    </div>

    <h2 class="ui header">Tags</h2>
    <p>
        <button class="ui positive button" {% if read_only or not can_save_delete %}style="display: none;"{% end %} onClick="policyEditor.addTagField();">Create New Tag</button>
    </p>
<div>
    <form id="tagForm" autocomplete="off" method="post" onsubmit="return false;">
        {% module xsrf_form_html() %}
        <div class="ui form">
            {% set i=0 %}
            {% for tag in resource_details["TagSet"] %}
            <div class="fields">
                <div class="field">
                    <label>Tag name</label>
                    <input type="text" name=existingtag_{{ i }} placeholder="Name" value="{{ tag["Key"] }}" disabled>
                </div>
                <div class="field">
                    <label>Tag value</label>
                    <input type="text" name=existingtagvalue_{{ i }} placeholder="Value" value="{{ tag["Value"] }}" {% if read_only or not can_save_delete %}disabled{% end %}>
                </div>
                <input type="hidden" name=existingtagoldvalue_{{ i }} value="{{ tag["Value"] }}">
                <div class="field">
                    <button class="ui red button" type="delete" {% if read_only or not can_save_delete %}style="display: none;"{% else %}style="margin: 23px;width: 150px;"{% end %} onClick="policyEditor.deleteTag('{{ tag["Key"] }}')">
                        Delete Tag
                    </button>
                </div>
                {% set i += 1 %}
            </div>
            {% end %}
            <div id="new_tags"></div>
        </div>
        <div id="tagwarning" class="ui negative message" style="display: none;">
          <div class="header">
            Error!
          </div>
            <p id="tagwarningmsg"></p>
        </div>
        <p>
            <button id="tagsavebutton" {% if read_only or not can_save_delete %}style="display: none;"{% end %} class="ui primary button" type="save" onClick="policyEditor.setTags();" style="margin: 10px;">Save</button>
        </p>
    </form>
</div>

<script>
    $('.ui.accordion').accordion();
</script>

<style>
    body.swal2-shown:not(.swal2-no-backdrop):not(.swal2-toast-shown), html.swal2-shown:not(.swal2-no-backdrop):not(.swal2-toast-shown) { height: 100% !important; overflow-y: visible !important; }
</style>

<script src="/static/js/dist/policyEditor.js"></script>
{% include "footer.html" %}