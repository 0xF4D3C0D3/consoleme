{% include "header.html" %}


<div id="wrapper" class="container">
    <div id="error_div" class="ui hidden error message">
        <i class="close icon"></i>
        <div class="header">
            Oops!
        </div>
        <p id="error_response"></p>
    </div>
    <div id="success_div" class="ui hidden positive message">
        <i class="close icon"></i>
        <div class="header">
            Success!
        </div>
        <p id="success_response"></p>
    </div>
    <h2 class="ui header">
        <i class="ticket alternate icon"></i>
        <div class="content">
            Request access to a group
        </div>
    </h2>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/1.10.19/js/dataTables.semanticui.min.js"></script>
    <script>
        function getCookie(name) {
            var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
            return r ? r[1] : undefined;
        }

        function sendRequest(json, endpoint) {
            var XHR = new XMLHttpRequest();
            var xsrf = getCookie("_xsrf");
            var req = JSON.parse(json);

            XHR.addEventListener("load", function (event) {
                try {
                    var res = JSON.parse(event.target.responseText);
                } catch (err) {
                    console.log(err);
                    res = {};
                }
                if (res.status == "error") {
                    var element = document.getElementById("error_response");
                    element.textContent = res.message;
                    document.getElementById("error_div").classList.remove("hidden");
                } else if (res.status == "success") {
                    var element = document.getElementById("success_response");
                    element.textContent = res.message;
                    document.getElementById("success_div").classList.remove("hidden");
                    if (!!res.url) {
                        window.location.replace(res.url);
                    }

                } else {
                    var element = document.getElementById("error_response");
                    element.textContent = event.target.responseText;
                    document.getElementById("error_div").classList.remove("hidden");
                }
            });

            XHR.addEventListener("error", function (event) {
                alert('Oops! Something went wrong.');
            });

            // Set up our request
            XHR.open("POST", endpoint);
            XHR.setRequestHeader("X-Xsrftoken", xsrf);

            XHR.send(json);
        }

        function removeUser(user) {
            var arr = [{"name": "remove_members", "value": user}]
            var json = JSON.stringify(arr);
            sendRequest(json, "/accessui/group/{{group.name}}");
        }

    </script>
    <form class="ui form" id="group_request_form" name="group_request_form">
        {% module xsrf_form_html() %}
        <div class="ui list" style="width: 900px;">
            <div class="item">
                <div class="ui red header">User: {{ escape(user) }}</div>
                <br/><br/>
            </div>
            <div class="item">
                <div class="ui red header">Group: {{ escape(group.name) }}</div>
                You are requesting access to this group. <br/><br/>
            </div>
            {% if group.secondary_approvers %}
            <div class="item">
                <div class="ui red header">Secondary Approvers: {{ escape(", ".join(group.secondary_approvers)) }}</div>
                The secondary approvers for this group will be notified about your request. After making the request,
                you may also send a direct link to the request to the secondary approvers.
            </div>
            {% else %}
            <div class="item">
                <div class="header">No Secondary Approvers</div>
                There are no secondary approvers configured for this group. You will be added to the group
                immediately. Please wait up to 30 minutes after being added to be able to use the applicable
                permissions, as
                it will take time to propagate the new permission. <br/><br/>
            </div>
            {% end %}
        </div>
        {% module xsrf_form_html() %}

        <div class="ui form">
            <div class="field">
                <h3 class="ui header">
                    <i class="circular users icon"></i>
                    <div class="content">
                        Please enter your justification.
                    </div>
                    <textarea name=justification rows="2" required></textarea>
                </h3>
            </div>
        </div>
        <br/>
        <button class="ui primary button" type="submit">Submit</button>
        <br/><br/>
    </form>
    </main>
</div>
</body>
</html>

<script>
    $('.message .close').on('click', function () {
        $(this).closest('.message').transition('fade');
    });

    document.getElementById("group_request_form").addEventListener("submit", function (event) {
        event.preventDefault();
        var arr = $(this).serializeArray();
        var json = JSON.stringify(arr);
        sendRequest(json, "/accessui/request_access/{{group.name}}");
    });

</script>

